name: Release

on:
  push:
    branches:
      - main
    paths:
      - Cargo.toml

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: |
            x86_64-unknown-linux-gnu
            x86_64-pc-windows-gnu

      - name: Install cross-compilation tools
        run: |
          sudo apt-get update
          sudo apt-get install -y mingw-w64

      - name: Extract version from Cargo.toml
        id: version
        run: |
          VERSION=$(grep '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Get latest release tag
        id: latest_release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG=$(gh release view --json tagName --jq .tagName 2>/dev/null || echo "")
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Check if version already released
        if: steps.latest_release.outputs.tag == format('v{0}', steps.version.outputs.version)
        run: |
          echo "Version already released. Exiting."
          exit 0

      - name: Build Linux binary
        run: |
          cargo build --release --target x86_64-unknown-linux-gnu

      - name: Build Windows binary
        run: |
          cargo build --release --target x86_64-pc-windows-gnu

      - name: Prepare artifacts
        run: |
          BIN_NAME=$(cargo metadata --no-deps --format-version=1 | jq -r '.packages[0].name')

          mkdir dist
          cp target/x86_64-unknown-linux-gnu/release/$BIN_NAME \
             dist/${BIN_NAME}-linux-x86_64
          cp target/x86_64-pc-windows-gnu/release/$BIN_NAME.exe \
             dist/${BIN_NAME}-windows-x86_64.exe

      - name: Create GitHub release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          gh release create v$VERSION \
            dist/* \
            --title "v$VERSION" \
            --notes "Release v$VERSION"
